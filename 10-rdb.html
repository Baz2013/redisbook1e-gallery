<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>第 10 章：RDB 持久化 &mdash; 《Redis 设计与实现》图片集</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="《Redis 设计与实现》图片集" href="index.html" />
    <link rel="next" title="第 11 章： AOF 持久化" href="11-aof.html" />
    <link rel="prev" title="第 9 章：数据库" href="9-db.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="11-aof.html" title="第 11 章： AOF 持久化"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="9-db.html" title="第 9 章：数据库"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">《Redis 设计与实现》图片集</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="rdb">
<h1>第 10 章：RDB 持久化<a class="headerlink" href="#rdb" title="Permalink to this headline">¶</a></h1>
<p>Redis 服务器数据库示例。</p>
<p class="graphviz">
<img src="_images/graphviz-8a39c23741ca2d627dbb285bbc89b58d4a4b54d3.png" alt="digraph {

    rankdir = LR;

    node [shape = record];

    label = &quot;\n图 10-1    数据库状态示例&quot;;

    subgraph cluster_server {

        label = &quot;Redis 服务器&quot;;

        db0 [label = &quot;数据库 0 | { k1 | v1} | { k2 | v2 } | { k3 | v3 }&quot;];

        db1 [label = &quot;数据库 1 | { k1 | v1} | { k2 | v2 } | { k3 | v3 }&quot;];

        db2 [label = &quot;数据库 2 | { k1 | v1} | { k2 | v2 } | { k3 | v3 }&quot;];

        db0-&gt;db1 -&gt; db2 [style = invis];

    }

}" />
</p>
<hr class="docutils" />
<p>Redis 保存和载入 RDB 文件的流程。</p>
<p class="graphviz">
<img src="_images/graphviz-798fc56f5bdbd23098e3880a0d90b79a9e6708f9.png" alt="digraph {

    rankdir = LR;

    label = &quot;\n图 10-2    将数据库状态保存为 RDB 文件&quot;;

    //

    state [label = &quot;数据库状态&quot;, shape = circle];

    rdb [label = &quot;RDB 文件&quot;, shape = note, height = 1.8, width = 1.4];

    //

    state -&gt; rdb [label = &quot;保存为&quot;, minlen = 2.5];

}" />
</p>
<p class="graphviz">
<img src="_images/graphviz-d41bde2b83e67cb9599ee75dbaf4d5feb7242a53.png" alt="digraph {

    rankdir = LR;

    label = &quot;\n图 10-3    用 RDB 文件来还原数据库状态&quot;;

    //

    state [label = &quot;数据库状态&quot;, shape = circle];

    rdb [label = &quot;RDB 文件&quot;, shape = note, height = 1.8, width = 1.4];

    //

    state -&gt; rdb [dir = back, label = &quot;还原&quot;, minlen = 2.5];

}" />
</p>
<div class="section" id="id1">
<h2>RDB 文件的创建与载入<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>服务器判断是载入 RDB 文件还是载入 AOF 文件的流程。</p>
<p class="graphviz">
<img src="_images/graphviz-986d4a4a299a82a0cd9189c88eff8df037620bfe.png" alt="digraph {

    label = &quot;\n图 10-4    服务器载入文件时的判断流程&quot;;

    node [shape = box];

    //

    server_star [label = &quot;服务器启动&quot;, width = 3]

    start_load [label = &quot;执行载入程序&quot;, width = 3];

    aof_or_not [label = &quot;已开启 AOF 持久化功能？&quot;, shape = diamond];

    load_by_aof [label = &quot;载入 AOF 文件&quot;];

    load_by_rdb [label = &quot;载入 RDB 文件&quot;];

    //

    server_star -&gt; start_load -&gt; aof_or_not;

    aof_or_not -&gt; load_by_aof [label = &quot;是&quot;];

    aof_or_not -&gt; load_by_rdb [label = &quot;否&quot;];

}" />
</p>
<hr class="docutils" />
<p>负责创建和载入 RDB 文件的两个函数之间的关系。</p>
<p class="graphviz">
<img src="_images/graphviz-ee236a7d053c54dd556f416a721361dbd58cf03c.png" alt="digraph {

    label = &quot;\n图 10-5    创建和载入 RDB 文件&quot;;

    rankdir = LR;

    splines = polyline

    //

    node [shape = circle, width = 1.3, height = 1.3];

    state [label = &quot;数据库状态&quot;];

    rdb [label = &quot;RDB 文件&quot;];

    //

    edge [minlen = 2.5];

    state -&gt; rdb [label = &quot;rdbSave&quot;];

    rdb -&gt; state [label = &quot;\nrdbLoad&quot;];

}" />
</p>
</div>
<div class="section" id="id2">
<h2>自动间隔性保存<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>记录了服务器触发自动 <code class="docutils literal"><span class="pre">BGSAVE</span></code> 条件的 <code class="docutils literal"><span class="pre">saveparams</span></code> 属性。</p>
<p class="graphviz">
<img src="_images/graphviz-153da551bf9e92b62462918adadb65719a0ca943.png" alt="digraph {

    label = &quot;\n图 10-6    服务器状态中的保存条件&quot;;

    rankdir = LR;

    node [shape = record];

    //

    redisServer [label = &quot; redisServer | ... | &lt;saveparams&gt; saveparams | ... &quot;];

    saveparams [label = &quot; { { saveparams[0] | seconds \n 900 | changes \n 1 } | { saveparams[1] | seconds \n 300 | changes \n 10 } | { saveparams[2] | seconds \n 60 | changes \n 10000 } } &quot;];

    //

    redisServer:saveparams -&gt; saveparams;

}" />
</p>
<hr class="docutils" />
<p>记录服务器最后一次执行 <code class="docutils literal"><span class="pre">SAVE</span></code> 或者 <code class="docutils literal"><span class="pre">BGSAVE</span></code> 的时间，
以及自最后一次保存 RDB 文件以来，
服务器进行了多少次写入的 <code class="docutils literal"><span class="pre">lastsave</span></code> 属性和 <code class="docutils literal"><span class="pre">dirty</span></code> 属性。</p>
<p class="graphviz">
<img src="_images/graphviz-d5752af0944a18d5528c28dea77bdb4b05a339d6.png" alt="digraph {

    label = &quot;\n图 10-7    服务器状态示例&quot;;

    rankdir = LR;

    node [shape = record];

    //

    redisServer [label = &quot; redisServer | ... | dirty \n 123 | lastsave \n 1378270800 | ... &quot;];

}" />
</p>
<hr class="docutils" />
<p>用于记录和检查服务器是否需要自动执行 <code class="docutils literal"><span class="pre">BGSAVE</span></code> 的相关属性和数据结构的示例。</p>
<p class="graphviz">
<img src="_images/graphviz-4c1e6c09a6bc61293ab66453d8f44c2fa384452c.png" alt="digraph {

    label = &quot;\n图 10-8    服务器状态&quot;;

    rankdir = LR;

    node [shape = record];

    //

    redisServer [label = &quot; redisServer | ... | &lt;saveparams&gt; saveparams | ... | dirty \n 123 | lastsave \n 1378270800 | ... &quot;];

    saveparams [label = &quot; { { saveparams[0] | seconds \n 900 | changes \n 1 } | { saveparams[1] | seconds \n 300 | changes \n 10 } | { saveparams[2] | seconds \n 60 | changes \n 10000 } } &quot;];

    //

    redisServer:saveparams -&gt; saveparams;

}" />
</p>
</div>
<div class="section" id="id3">
<h2>RDB 文件结构<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>RDB 文件的总体结构。</p>
<p class="graphviz">
<img src="_images/graphviz-6e887288b93260b3d6ebfdece316276c2e5295c9.png" alt="digraph {

    label = &quot;\n图 10-10    RDB 文件结构&quot;;

    node [shape = record];

    rdb [label = &quot; REDIS | db_version | databases | EOF | check_sum &quot;];

}" />
</p>
<p>包含数据库 <code class="docutils literal"><span class="pre">0</span></code> 和数据库 <code class="docutils literal"><span class="pre">3</span></code> 的非空 RDB 文件结构示例。</p>
<p class="graphviz">
<img src="_images/graphviz-bd17f60df2182d64acb1bca39eaaff8c113b1c0b.png" alt="digraph {

    label = &quot;\n图 10-12    带有两个非空数据库的 RDB 文件示例&quot;;

    node [shape = record];

    rdb [label = &quot; REDIS | db_version | database 0 | database 3 | EOF | check_sum &quot;];

}" />
</p>
<hr class="docutils" />
<p>RDB 文件中的数据库结构。</p>
<p class="graphviz">
<img src="_images/graphviz-098e60e3aee59877e2135910b18aecbee9600671.png" alt="digraph {

    label = &quot;\n图 10-13    RDB 文件中的数据库结构&quot;;

    node [shape = record];

    database [label = &quot; SELECTDB | db_number | key_value_pairs &quot;];

}" />
</p>
<p>示例。</p>
<p class="graphviz">
<img src="_images/graphviz-a09ee7e4d84ddc0b83b7bc643f6d3508e773d2bd.png" alt="digraph {

    label = &quot;\n图 10-14    数据库结构示例&quot;;

    node [shape = record];

    value [label = &quot; SELECTDB | 0 | key_value_pairs &quot;];

}" />
</p>
<p>包含了数据库部分的 RDB 文件示例。</p>
<p class="graphviz">
<img src="_images/graphviz-7b5b907ea852666aa3f28d0ce666bd94234e9ed5.png" alt="digraph {

    label = &quot;\n图 10-15    RDB 文件中的数据库结构示例&quot;;

    node [shape = record];

    v [label = &quot; REDIS | db_version | SELECTDB | 0 | pairs | SELECTDB | 3 | pairs | EOF | check_sum&quot;];

}" />
</p>
<hr class="docutils" />
<p>不带过期时间的键值对结构。</p>
<p class="graphviz">
<img src="_images/graphviz-221587f8dc5aa7a0280c131b44ae2ea5f21e47a4.png" alt="digraph {

    label = &quot;\n图 10-16    不带过期时间的键值对&quot;;

    node [shape = record];

    kvp [label = &quot; TYPE | key | value &quot;];

}" />
</p>
<p>示例。</p>
<p class="graphviz">
<img src="_images/graphviz-399f2db07f64f8be3f778ae387091fb93d54cc72.png" alt="digraph {

    label = &quot;\n图 10-18    无过期时间的字符串键值对示例&quot;;

    node [shape = record];

    string [label = &quot; REDIS_RDB_TYPE_STRING | key | value &quot;];

}" />
</p>
<hr class="docutils" />
<p>带有过期时间的键值对结构。</p>
<p class="graphviz">
<img src="_images/graphviz-be169c701ae8db66da9f1eb0b1d69da5253179ae.png" alt="digraph {

    label = &quot;\n图 10-17    带有过期时间的键值对&quot;;

    node [shape = record];

    kvp [label = &quot; EXPIRETIME_MS | ms | TYPE | key | value &quot;];

}" />
</p>
<p>示例。</p>
<p class="graphviz">
<img src="_images/graphviz-6a02fd30c406631a2bc66942c91ec3d4766dfbf6.png" alt="digraph {

    label = &quot;\n图 10-19    带有过期时间的集合键值对示例&quot;;

    node [shape = record];

    set [label = &quot; EXPIRETIME_MS | 1388556000000 | REDIS_RDB_TYPE_SET | key | value &quot;];

}" />
</p>
<hr class="docutils" />
<p><code class="docutils literal"><span class="pre">int</span></code> 编码的字符串对象的结构。</p>
<p class="graphviz">
<img src="_images/graphviz-b7a2497e808531d46c05e25d85b063dae56cdb1a.png" alt="digraph {

    label = &quot;\n图 10-20    INT 编码字符串对象的保存结构&quot;;

    node [shape = record];

    v [label = &quot; ENCODING | integer &quot;];

}" />
</p>
<p>示例。</p>
<p class="graphviz">
<img src="_images/graphviz-97c91e91d7e08d22bd2eef0640a807e6d2fe5de5.png" alt="digraph {

    label = &quot;\n图 10-21    用 8 位来保存整数的例子&quot;;

    node [shape = record];

    v [label = &quot; REDIS_RDB_ENC_INT8 | 123 &quot;];

}" />
</p>
<hr class="docutils" />
<p>内容没有被压缩的字符串对象的结构。</p>
<p class="graphviz">
<img src="_images/graphviz-60743b5b5199ae3172961dd04b886aebafc81ccc.png" alt="digraph {

    label = &quot;\n图 10-22    无压缩字符串的保存结构&quot;;

    node [shape = record];

    value [ label = &quot; len | string &quot;];

}" />
</p>
<p>示例。</p>
<p class="graphviz">
<img src="_images/graphviz-f92f4d657873b98467f7d388ebac68219bc41dd8.png" alt="digraph {

    label = &quot;\n图 10-24    无压缩的字符串&quot;;

    node [shape = record];

    value [ label = &quot; 5 | \&quot;hello\&quot; &quot;];

}" />
</p>
<hr class="docutils" />
<p>内容被压缩后的字符串对象的结构。</p>
<p class="graphviz">
<img src="_images/graphviz-3b82d4c74bb5056fbfdc736b22fa02d4ff51743f.png" alt="digraph {

    label = &quot;\n图 10-23    压缩后字符串的保存结构&quot;;

    node [shape = record];

    value [ label = &quot; REDIS_RDB_ENC_LZF | compressed_len | origin_len | compressed_string &quot;];

}" />
</p>
<p>示例，
其中 <code class="docutils literal"><span class="pre">?</span></code> 代表的是无法用字符串形式打印出来的字节。</p>
<p class="graphviz">
<img src="_images/graphviz-b029dd5cf37e631d19577283fabf7de3da3dba39.png" alt="digraph {

    label = &quot;\n图 10-25    压缩后的字符串&quot;;

    node [shape = record];

    value [label = &quot; REDIS_RDB_ENC_LZF | 6 | 21 | \&quot;?aa???\&quot; &quot;];

}" />
</p>
<hr class="docutils" />
<p>列表对象的结构。</p>
<p class="graphviz">
<img src="_images/graphviz-7813b37724ed00ea45f67d39b84429f6c4309c00.png" alt="digraph {

    label = &quot;\n图 10-26    LINKEDLIST 编码列表对象的保存结构&quot;;

    node [shape = record];

    value [label = &quot; list_length | item1 | item2 | ... | itemN &quot;];

}" />
</p>
<p>示例。</p>
<p class="graphviz">
<img src="_images/graphviz-a952d1b7172803692c31235cba90dc8fd6dc8bca.png" alt="digraph {

    label = &quot;\n图 10-27    保存 LINKEDLIST 编码列表的例子&quot;;

    node [shape = record];

    list [label = &quot; 3 | 5 | \&quot;hello\&quot; | 5 | \&quot;world\&quot;  |  1 | \&quot;!\&quot;  &quot;];

}" />
</p>
<hr class="docutils" />
<p>集合对象的结构。</p>
<p class="graphviz">
<img src="_images/graphviz-5c0556db8fbfa9707b2d9fdf9d3a36fa37cda948.png" alt="digraph {

    label = &quot;\n图 10-28    HT 编码集合对象的保存结构&quot;;

    node [shape = record];

    value [ label = &quot; set_size | elem1 | elem2 | ... | elemN &quot;];

}" />
</p>
<p>示例。</p>
<p class="graphviz">
<img src="_images/graphviz-5fd000e305cbb82318676adb0d3c641c068b83bb.png" alt="digraph {

    label = &quot;\n图 10-29    保存 HT 编码集合的例子&quot;;

    node [shape = record];

    set [label = &quot; 4 | 5 | \&quot;apple\&quot; | 6 | \&quot;banana\&quot; | 3 | \&quot;cat\&quot; | 3 | \&quot;dog\&quot; &quot;];

}" />
</p>
<hr class="docutils" />
<p>哈希对象的结构。</p>
<p class="graphviz">
<img src="_images/graphviz-cf4df030887b147abf6b1b4f0d562ec0e64cdfde.png" alt="digraph {

    label = &quot;\n图 10-30    HT 编码哈希表对象的保存结构&quot;;

    node [shape = record];

    hash [label = &quot; hash_size | key_value_pair 1 | key_value_pair 2 | ... | key_value_pair N &quot;];

}" />
</p>
<p>更详细的哈希对象结构。</p>
<p class="graphviz">
<img src="_images/graphviz-d72bf68a7f4eab336b3448c55642ac058ab7ae4c.png" alt="digraph {

    label = &quot;\n图 10-32    更详细的 HT 编码哈希表对象的保存结构&quot;;

    node [shape = record];

    hash [label = &quot; hash_size | key1 | value1 | key2 | value2 | ... | keyN | valueN &quot;];
}" />
</p>
<p>示例。</p>
<p class="graphviz">
<img src="_images/graphviz-b4fad754a51b13223ef110eacaf73648ecf69f62.png" alt="digraph {

    label = &quot;\n图 10-33    保存 HT 编码哈希表的例子&quot;;

    node [shape = record];

    hash [label = &quot; 2 | 1 | \&quot;a\&quot; | 5 | \&quot;apple\&quot; | 1 | \&quot;b\&quot; | 6 | \&quot;banana\&quot; &quot;];
}" />
</p>
<hr class="docutils" />
<p>有序集合对象结构。</p>
<p class="graphviz">
<img src="_images/graphviz-9c7c8783d61ecc27f0e5c0e354ac116720775cae.png" alt="digraph {

    label = &quot;\n图 10-34    SKIPLIST 编码有序集合对象的保存结构&quot;;

    node [shape = record];

    zset [label = &quot; sorted_set_size | element1 | element2 | ... | elementN &quot;];

}" />
</p>
<p>更详细的有序集合对象结构。</p>
<p class="graphviz">
<img src="_images/graphviz-4eccee1e3bb76e2fdda791119a2fc56a7a5fb06e.png" alt="digraph {

    label = &quot;\n图 10-36    更详细的 SKIPLIST 编码有序集合对象的保存结构&quot;;

    node [shape = record];

    sorted_set [label = &quot; sorted_set_size | member1 | score1 | member2 | score2 | ... | memberN | scoreN &quot;];

}" />
</p>
<p>示例。</p>
<p class="graphviz">
<img src="_images/graphviz-41b13838f8db4df01d8654f2fd92c1d2fef2181f.png" alt="digraph {

    label = &quot;\n图 10-37    保存 SKIPLIST 编码有序集合的例子&quot;;

    node [shape = record];

    sorted_set [label = &quot; 2 | 2 | \&quot;pi\&quot; | 4 | \&quot;3.14\&quot; | 1 | \&quot;e\&quot; | 3 | \&quot;2.7\&quot; &quot;];

}" />
</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">第 10 章：RDB 持久化</a><ul>
<li><a class="reference internal" href="#id1">RDB 文件的创建与载入</a></li>
<li><a class="reference internal" href="#id2">自动间隔性保存</a></li>
<li><a class="reference internal" href="#id3">RDB 文件结构</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="9-db.html"
                        title="previous chapter">第 9 章：数据库</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="11-aof.html"
                        title="next chapter">第 11 章： AOF 持久化</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/10-rdb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="11-aof.html" title="第 11 章： AOF 持久化"
             >next</a> |</li>
        <li class="right" >
          <a href="9-db.html" title="第 9 章：数据库"
             >previous</a> |</li>
        <li><a href="index.html">《Redis 设计与实现》图片集</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, 黄健宏（huangz）.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b1.
    </div>
  </body>
</html>